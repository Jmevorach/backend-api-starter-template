name: Python Lambda CI

on:
  push:
    branches: [main]
    paths:
      - "infra/lambdas/**"
      - "pyproject.toml"
      - ".github/workflows/python-lambda-ci.yml"
  pull_request:
    branches: [main]
    paths:
      - "infra/lambdas/**"
      - "pyproject.toml"
      - ".github/workflows/python-lambda-ci.yml"

env:
  PYTHON_VERSION: "3.14"

jobs:
  lint-and-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy bandit
          pip install boto3-stubs[secretsmanager,rds,ecs,elasticache]

      - name: Run Ruff (linter)
        run: ruff check infra/lambdas

      - name: Run Ruff (formatter check)
        run: ruff format --check infra/lambdas

      - name: Run mypy (type checker)
        run: mypy infra/lambdas

      - name: Run Bandit (security scanner)
        run: bandit -r infra/lambdas -ll

      - name: Verify Lambda syntax
        run: |
          for f in infra/lambdas/*/lambda_function.py; do
            python -m py_compile "$f"
          done
